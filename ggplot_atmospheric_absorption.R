library(ggplot2)

magnitude_1p <- function(angle, cutoff)
{
  ratio <- angle/cutoff
  magnitudeDb <- -10 * log10(1 + ratio*ratio)
  magnitudeDb
}

magnitude_2p <- function(angle, cutoff)
{
  ratio <- angle/cutoff
  ratio <- ratio*ratio
  magnitudeDb <- -10 * log10(1 + ratio*ratio)
  magnitudeDb
}

aac_filter_cuttoff <<- 5000
aac_freq_range <<- c(20.000,21.430,22.963,24.605,26.365,28.251,30.271,32.436,34.756,37.242,39.905,42.759,45.817,49.094,52.605,56.368,60.399,64.719,69.347,74.307,79.621,85.316,91.418,97.956,104.962,112.468,120.512,129.131,138.366,148.262,158.866,170.228,182.402,195.447,209.426,224.404,240.453,257.650,276.077,295.822,316.979,339.649,363.940,389.969,417.859,447.744,479.767,514.079,550.846,590.242,632.456,677.688,726.156,778.090,833.739,893.367,957.260,1025.723,1099.082,1177.687,1261.915,1352.166,1448.872,1552.494,1663.528,1782.502,1909.985,2046.586,2192.957,2349.795,2517.851,2697.926,2890.880,3097.634,3319.174,3556.559,3810.922,4083.476,4375.524,4688.458,5023.773,5383.070,5768.063,6180.591,6622.623,7096.269,7603.789,8147.606,8730.317,9354.704,10023.746,10740.637,11508.800,12331.901,13213.870,14158.917,15171.553,16256.612,17419.273,18665.088,20000.002)
aac_aac_75_75 <<- c(0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0001,0.0001,0.0001,0.0001,0.0001,0.0001,0.0001,0.0001,0.0002,0.0002,0.0002,0.0002,0.0003,0.0003,0.0003,0.0004,0.0004,0.0005,0.0006,0.0007,0.0007,0.0008,0.0010,0.0011,0.0012,0.0014,0.0015,0.0017,0.0019,0.0021,0.0023,0.0026,0.0028,0.0031,0.0034,0.0036,0.0039,0.0042,0.0045,0.0048,0.0051,0.0055,0.0058,0.0061,0.0064,0.0068,0.0071,0.0075,0.0079,0.0083,0.0087,0.0092,0.0097,0.0103,0.0109,0.0117,0.0125,0.0134,0.0144,0.0156,0.0169,0.0184,0.0201,0.0221,0.0244,0.0270,0.0300,0.0334,0.0373,0.0417,0.0469,0.0527,0.0595,0.0672,0.0760,0.0861,0.0976,0.1108,0.1259,0.1431,0.1628,0.1852,0.2108,0.2399,0.2730,0.3105,0.3531)
aac_aac_03_110 <<- c(0.0001,0.0001,0.0001,0.0001,0.0002,0.0002,0.0002,0.0002,0.0003,0.0003,0.0003,0.0004,0.0004,0.0004,0.0005,0.0006,0.0006,0.0007,0.0007,0.0008,0.0009,0.0009,0.0010,0.0011,0.0012,0.0013,0.0013,0.0014,0.0015,0.0016,0.0017,0.0018,0.0019,0.0020,0.0022,0.0023,0.0025,0.0026,0.0028,0.0030,0.0033,0.0035,0.0038,0.0042,0.0046,0.0050,0.0055,0.0061,0.0068,0.0075,0.0084,0.0094,0.0105,0.0118,0.0132,0.0149,0.0168,0.0189,0.0213,0.0240,0.0271,0.0306,0.0345,0.0388,0.0437,0.0491,0.0551,0.0617,0.0689,0.0768,0.0853,0.0945,0.1044,0.1148,0.1258,0.1373,0.1492,0.1614,0.1739,0.1865,0.1991,0.2116,0.2239,0.2360,0.2477,0.2591,0.2700,0.2805,0.2906,0.3002,0.3095,0.3185,0.3273,0.3359,0.3445,0.3531,0.3619,0.3710,0.3806,0.3908,0.4018)
aac_aac_50_20 <<- c(0.0000,0.0000,0.0000,0.0000,0.0000,0.0001,0.0001,0.0001,0.0001,0.0001,0.0001,0.0001,0.0001,0.0001,0.0001,0.0002,0.0002,0.0002,0.0002,0.0002,0.0002,0.0002,0.0003,0.0003,0.0003,0.0003,0.0004,0.0004,0.0004,0.0005,0.0005,0.0006,0.0006,0.0007,0.0007,0.0008,0.0009,0.0010,0.0011,0.0013,0.0014,0.0016,0.0018,0.0020,0.0023,0.0026,0.0029,0.0033,0.0038,0.0043,0.0048,0.0055,0.0062,0.0070,0.0079,0.0089,0.0101,0.0113,0.0127,0.0143,0.0160,0.0178,0.0198,0.0220,0.0243,0.0268,0.0294,0.0321,0.0349,0.0379,0.0408,0.0438,0.0468,0.0498,0.0528,0.0557,0.0586,0.0613,0.0640,0.0666,0.0691,0.0715,0.0739,0.0762,0.0785,0.0808,0.0830,0.0854,0.0878,0.0904,0.0931,0.0960,0.0992,0.1027,0.1065,0.1109,0.1157,0.1212,0.1275,0.1346,0.1426)
aac_aac_95_20 <<- c(0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0001,0.0001,0.0001,0.0001,0.0001,0.0001,0.0001,0.0001,0.0001,0.0002,0.0002,0.0002,0.0002,0.0002,0.0002,0.0003,0.0003,0.0003,0.0003,0.0004,0.0004,0.0004,0.0004,0.0005,0.0005,0.0005,0.0006,0.0006,0.0007,0.0007,0.0008,0.0008,0.0009,0.0010,0.0011,0.0012,0.0013,0.0014,0.0016,0.0018,0.0020,0.0022,0.0025,0.0028,0.0032,0.0036,0.0041,0.0046,0.0052,0.0059,0.0067,0.0076,0.0086,0.0098,0.0111,0.0126,0.0143,0.0162,0.0184,0.0209,0.0236,0.0266,0.0300,0.0338,0.0380,0.0426,0.0476,0.0531,0.0590,0.0653,0.0721,0.0792,0.0868,0.0947,0.1028,0.1113,0.1198,0.1286,0.1374,0.1462,0.1551,0.1639,0.1727,0.1815,0.1903,0.1991,0.2081,0.2172,0.2266,0.2364,0.2467,0.2577)

build_dataframe <- function(distance, testNum = 1)
{
  aac_table <- aac_aac_75_75
  if (testNum == 2) { aac_table <- aac_aac_03_110 }
  if (testNum == 3) { aac_table <- aac_aac_50_20 }
  if (testNum == 4) { aac_table <- aac_aac_95_20 }
  aac_db <- -distance * aac_aac_75_75
  i <- 1
  while (aac_db[[i]] > -3.0) { i <- i + 1 }
  filter_cuttoff <- aac_freq_range[[i]]
  
  approx_db <- magnitude_1p(aac_freq_range, filter_cuttoff)
  approx_db2 <- magnitude_2p(aac_freq_range, filter_cuttoff)
  aac_df <- data.frame(frequency=aac_freq_range, absorb=aac_db, approx=approx_db, approx2=approx_db2)
}

build_aac_dataframe <- function()
{
  data.frame(frequency=aac_freq_range, aec75=aac_aac_75_75, aec110=aac_aac_03_110, aec20=aac_aac_50_20, aec20_2=aac_aac_95_20)
}

# CairoPNG("C:/Programming/AA_Coeffients2.png", 800, 480)
plotAec <- function()
{
  line1 <- geom_line(aes(x=frequency,y=-1*aec75, color=" 75F 75% H"))
  line2 <- geom_line(aes(x=frequency,y=-1*aec110, color="110F 3% H"))
  line3 <- geom_line(aes(x=frequency,y=-1*aec20, color=" 20F 50%H"))
  line4 <- geom_line(aes(x=frequency,y=-1*aec20_2, color=" 20F 95%H"))
  
  x_axis <- scale_x_continuous("Frequency (Hz)", trans='log10', breaks = c(0, 10, 20, 40, 60, 90, 150, 250, 450, 800, 1400, 2600, 5000, 10000, 18500))
  y_axis <- scale_y_continuous("dB/meter")
  
  ac_labels <- labs(title = "Atmospheric Absorption", color = "")
  
  coords <- coord_cartesian(ylim=c(0,-0.3), xlim=c(40,16000))
  
  df_aac <- build_aac_dataframe()
  
  ggplot(df_aac) + theme_bw() + ac_labels + line1 + line2 + line3 + line4 +
      x_axis + y_axis + coords
}

plot <- function(distance, testNum, bLine3 = 0)
{
  aac_title <-  "75°F 75% Humidity"
  if (testNum == 2) { aac_title <-  "110°F 3% Humidity" }
  if (testNum == 3) { aac_title <-  "20°F 50% Humidity" }
  if (testNum == 4) { aac_title <-  "20°F 95% Humidity" }
  
  line1 <- geom_line(aes(x=frequency,y=absorb, color="Absorption Amount"), size=0.75)
  line2 <- geom_line(aes(x=frequency,y=approx, color="LPF 1 Pole"))
  line3 <- geom_line(aes(x=frequency,y=approx2, color="LPF 2 Pole"))
  
  x_axis <- scale_x_continuous("Frequency (Hz)", trans='log10', breaks = c(0, 10, 20, 40, 60, 90, 150, 250, 450, 800, 1400, 2600, 5000, 10000, 18500))
  y_axis <- scale_y_continuous("dB", breaks = c(0, -3, -6, -9, -12, -15, -18, -24, -30))

  coords <- coord_cartesian(ylim=c(0,-24), xlim=c(40,16000))
    alpha <- 3 # log10(20000) - log10(20)
  
  df_aac <- build_dataframe(distance, testNum)
  
  ac_labels <- labs(title = paste("Frequency Response at", aac_title, "at", distance, "Meters"), color = "")
  if (bLine3 != 0)
  {
    ggplot(df_aac) + theme_bw() + ac_labels + line1 + line2 + line3 +
      x_axis + y_axis + coords +
      geom_hline(yintercept=-3, linetype="dotted", color="blue")
  }
  else
  {
    ggplot(df_aac) + theme_bw() + ac_labels + line1 + line2 +
      x_axis + y_axis + coords +
      geom_hline(yintercept=-3, linetype="dotted", color="blue")
  }

}